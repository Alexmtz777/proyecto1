---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<div class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
		<div class="max-w-md w-full space-y-8">
			<div>
				<h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
					Acceso al Sistema
				</h2>
				<p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
					Inicia sesi√≥n como administrador o suscr√≠bete para recibir novedades
				</p>
			</div>

			<!-- Login para administradores -->
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
				<h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
					üîê Acceso Administrativo
				</h3>
				<form class="space-y-4" id="loginForm">
					<div>
						<label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
							Email
						</label>
						<input id="email" name="email" type="email" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700" placeholder="admin@delpalacioseguros.com">
					</div>
					<div>
						<label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
							Contrase√±a
						</label>
						<input id="password" name="password" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
					</div>
					<div>
						<button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
							Iniciar Sesi√≥n
						</button>
					</div>
				</form>
			</div>

			<!-- Separador -->
			<div class="relative">
				<div class="absolute inset-0 flex items-center">
					<div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
				</div>
				<div class="relative flex justify-center text-sm">
					<span class="px-2 bg-gray-50 dark:bg-gray-900 text-gray-500 dark:text-gray-400">O</span>
				</div>
			</div>

			<!-- Formulario de registro para newsletter -->
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
				<h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
					üìß Suscr√≠bete a nuestro newsletter
				</h3>
				<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
					Recibe las √∫ltimas novedades sobre seguros, consejos y ofertas especiales.
				</p>
				<form class="space-y-4" id="newsletterForm">
					<div>
						<label for="newsletterName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
							Nombre
						</label>
						<input id="newsletterName" name="name" type="text" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white dark:bg-gray-700" placeholder="Tu nombre completo">
					</div>
					<div>
						<label for="newsletterEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
							Email
						</label>
						<input id="newsletterEmail" name="email" type="email" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white dark:bg-gray-700" placeholder="tu@email.com">
					</div>
					<div class="flex items-center">
						<input id="newsletterConsent" name="consent" type="checkbox" required class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
						<label for="newsletterConsent" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
							Acepto recibir comunicaciones por email
						</label>
					</div>
					<div>
						<button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
							Suscribirse
						</button>
					</div>
				</form>
			</div>

			<!-- Informaci√≥n adicional -->
			<div class="text-center">
				<p class="text-xs text-gray-500 dark:text-gray-400">
					¬øEres agente de seguros? 
					<a href="mailto:admin@delpalacioseguros.com" class="text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300">
						Contacta para obtener acceso administrativo
					</a>
				</p>
			</div>
		</div>
	</div>

	<script>
		import { supabase } from '../lib/supabase';

		// Login form
		document.getElementById('loginForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const email = document.getElementById('email').value;
			const password = document.getElementById('password').value;

			try {
				const { data, error } = await supabase.auth.signInWithPassword({
					email,
					password
				});

				if (error) throw error;

				// Verificar el rol del usuario
				const { data: userData } = await supabase
					.from('users')
					.select('role')
					.eq('id', data.user.id)
					.single();

				if (userData?.role === 'admin') {
					window.location.href = '/admin';
				} else {
					alert('Acceso denegado. Solo administradores pueden acceder.');
				}
			} catch (error) {
				alert('Error al iniciar sesi√≥n: ' + error.message);
			}
		});

		// Newsletter form
		document.getElementById('newsletterForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const name = document.getElementById('newsletterName').value;
			const email = document.getElementById('newsletterEmail').value;
			const consent = document.getElementById('newsletterConsent').checked;

			if (!consent) {
				alert('Debes aceptar recibir comunicaciones por email.');
				return;
			}

			try {
				const { error } = await supabase
					.from('subscriptions')
					.insert({
						name,
						email,
						is_active: true
					});

				if (error) throw error;

				alert('¬°Gracias por suscribirte! Te mantendremos informado sobre las novedades.');
				document.getElementById('newsletterForm').reset();
			} catch (error) {
				if (error.code === '23505') {
					alert('Este email ya est√° suscrito.');
				} else {
					alert('Error al suscribirse: ' + error.message);
				}
			}
		});
	</script>
</Layout> 